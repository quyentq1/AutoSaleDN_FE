name: Deploy React Frontend (Vite)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run tests üß™
        run: npm test

      - name: Build Vite app
        run: npm run build

  deploy:
    runs-on: [self-hosted, Windows, X64]
    needs: build
    steps:
      - name: Checkout source (for dist folder)
        uses: actions/checkout@v3

      - name: Deploy dist to VPS
        shell: pwsh
        run: |
          $source = "./dist/*"
          $destination = "${{ secrets.FRONTEND_DEPLOY_PATH }}"

          # ƒê·∫£m b·∫£o th∆∞ m·ª•c ƒë√≠ch t·ªìn t·∫°i
          if (-not (Test-Path -Path $destination)) {
              New-Item -ItemType Directory -Path $destination -Force
              Write-Host "‚û°Ô∏è Created destination directory at '$destination'."
          }

          Write-Host "‚û°Ô∏è Copying files from '$source' to '$destination'..."
          Copy-Item -Path $source -Destination $destination -Recurse -Force

          if (Test-Path $destination) {
              Write-Host "‚úÖ Files copied successfully to '$destination'!"
          } else {
              Write-Error "‚ùå Destination not found. Something went wrong during copy."
              exit 1
          }
